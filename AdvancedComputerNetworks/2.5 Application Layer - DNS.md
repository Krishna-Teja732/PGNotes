
### 1. Domain Name System 
- Distributed database that translates host names to IP addresses using UDP protocol
- Defied in [RFC 1035](https://datatracker.ietf.org/doc/html/rfc1035/)
- Common internet terms are defined in [RFC 1983](https://datatracker.ietf.org/doc/html/rfc1983/)
- **Host name**
	- Name given to a machine (server or a PC)
	- Example host name: relay.foo.bar.com
	- The host name is declared in /etc/hosts
- **Canonical host name** [Reference](https://datatracker.ietf.org/doc/html/rfc1034#section-3.6.2)
	- **Alias**: Alternative names for the host. The alias is always the key of a CNAME DNS record. This alias will always point to the canonical name of the host
	- Canonical name is the name given to the host in the /etc/hostname file. A host can have only one canonical name. Multiple alias can point to the same canonical name
	- **Why have alias?**
		- Let the host 'tejapc' host a webserver and a mail server
		- We can have two alias mail.tejapc and web.tejapc point to the host name tejapc. Later when we want the web and the mail server to be hosted in different machines, only the DNS CNAME record has to be changed, and a new A type record for the new host needs to be added. 
		- The clients can still use the same alias without any issues
- **Fully qualified Domain name**
	- Full name given to a host
	- A fully qualified domain name (webserver.mywebsite.com)
		- The first part refers to a host name
			- Hostname is a name given to a individual machine
		- mywebsite is the domain name
		- .com is the top level domain
- **Domain name**
	- Style of the host name is called domain name
#### 1.1 DNS Server architecture
- Consists of a three level hierarchy
	- **Root Domain server:** 
		- When a DNS resolution request is received, Root server returns the address of a Top level Domain DNS server
		- These are a collection of servers distributed globally
	- **Top level Domain(TLD) DNS:**
		- When DNS resolution request is received, this server sends the address of the Authoritative server that matches the domain name
		- Each TLD will have a collection of servers
			- TLD examples: .org .edu .com 
		- Each top level domain can be maintained by a company
	- **Authoritative DNS**
		- This contains the URL to IP mapping
		- Companies can have their own authoritative server or pay other companies that maintain authoritative server
- Local DNS (default name server)
	- Another central component of the DNS Arch
	- Maintained by local ISP
	- Acts as a proxy for forwarding the DNS request
	- When a host connects to an ISP, the host receives an address of a local DNS server
- **Does the DNS Architecture always have three levels?**
	- No, this is an approximation of how dns query is resolved 
	- Example:  for the domain name \www.gate.org.in
	- When A DNS resolution is required for this name
		- First the DNS request is sent from the host machine to the local DNS
		- From local DNS to DNS servers, there will be 4 request response pairs 
			- 1st request: To root DNS -> the response will contain IP address of the .in TLD server
			- 2nd request: to TLD DNS of .in -> the response will contain the IP address of the .org TLD server
			- 3rd request: to TLD DNS of .org -> the response will contain the IP address of the gate website authoritative DNS server
			- 4th request: to Authoritative DNS -> the response will contain the IP address of the server that hosts the web page
- Notes
	- How does the DNS resolver know the IP of the root server?
		- These IP are hard coded in the resolver
	- Number of root DNS servers
		- 13 roots servers have multiple replicas
		- There are 13 unique IP addresses, but there are multiple machines that use these 13 addresses
		- **Anycast routing**: multiple machines using same IP address 
		- The multiple instance of the root server can be viewed in this website [Root servers org](https://root-servers.org/?authuser=0) 
		- The IP address of the root server is present in the [IANA website](https://www.iana.org/domains/root/servers)
#### 1.2 What happens when a host requires the IP of the domain \www.something.edu?
- Host connects to the internet via the access ISP
- ISP provides the host with an IP addr of a local DNS, the default router
	- If NetworkManager is used, NM will update the /etc/resolv.conf with the DNS IP that it received from the DHCP server
	- When disconnection from the internet, the NM server will remove the dns IP from the /etc/resolv.conf file
- Check in /etc/hosts if there are any mappings to the domain name
- The host sends a DNS request to the local DNS(IP of the local DNS was stored in the /etc/resolv.conf file) with the domain name \www.something.edu
- The local DNS forwards this request to the root DNS server 
	- Root DNS server finds the .edu in the request and sends the IP of a TLD DNS server as the response
- The local DNS server sends the domain name to the TLD server
	- The TLD DNS server sends the IP address of an authoritative server that matches the domain name as the response
- The local DNS server then sends the domain name to the Authoritative server
	- The authoritative server returns the ip address of the corresponding domain
- The local DNS server sends the IP address to the host
- **Problem with the above method of Domain name resolution**
	- A lot of request and response is required for the domain name resolution
		- **How to over come this problem**: DNS Caching
- **DNS Caching**:
	- Cache domain name mappings 
	- Each domain name mapping is invalidated after a period of time(Using the TTL field)
#### 1.3 DNS query types
- Iterative
	- Request for DNS resolution, immediately get back an IP which can be IP of another DNS server 
	- The local DNS host resolves DNS using this method
		- The local DNS host sends the request to root DNS, then gets a result from root DNS for a TLD DNS
		- Then request to the TLD DNS and receive Authoritative DNS and so on
- Recursive 
	- When a request is sent to the local DNS, the local DNS does not immediately return the IP, instead the local DNS sends another series of request and then sends the result to client
	- The query answer for a recursive call will always be the IP of the machine that hosts the domain
#### 1.4 DNS Record
- A DNS record consists of the following attributes:
	- Name
		- Domain name
	- Value
		- IP address
	- Type
		- Specifies what IP address is stored
	- TTL
		- Time to Live
	- Class
		- Each resource record has a class 
		- There are two classes: IN(internet), CH(Chaos)
- **Possible values for Type attribute**
	- Type = A
		- The name contains a host name
		- The value contains the IP address of the hostname
	- Type = NS (Name server)
		- The name contains a domain name
		- Value contains the hostname of the authoritative DNS server that knows the IP address of hosts in that domain
		- Each hotsname(present as the value in NS record) will have a A type record that maps the hostname to it's IP address
	- Type = CNAME (Canonical name record)
		- The name contains a host name
		- Value consists of a canonical host name
	- Type = MX
		- Name = host name of mail server
		- Value = canonical host name of mail server
- Difference between host names and domain names: [ref](https://superuser.com/questions/59093/difference-between-host-name-and-domain-name)
#### 1.5 Tools to analyze DNS records
- dig - CLI tool
- nslookup - CLI tool to interactively query name servers
- [Google's Admin toolbox](https://toolbox.googleapps.com/apps/main/)
- [DNS performance analysis](https://www.dnsperf.com)

### 2. DNS record analysis
- **DNS lookup** 
	- Resolve domain name to IP address
- **What is DNS reverse lookup?**
	- Resolve given IP address to a domain name 
- **What is Anycast routing?**
	- An IP address can be assigned to multiple interfaces
	- When a packet is sent using the anycast address, IP makes the best effort to send the packet to at least one of the interfaces with the anycast address
	- The packet with the anycast address is routed to the nearest interface. 
		- The nearest interface is determined using the distance measure using the in the routing algorithm
	- References for anycast routing - [References](./References/References)
- **How is anycast routing used in DNS?** 
	- There are 13 virtual root servers i.e. 13 anycast addresses
	- Each of these 13 anycast address is assigned to multiple interfaces
	- One of these anycast address is used to send a DNS query, the query will be sent to at least one of the interfaces that are associated with that anycast address
- **View Cache statistics of dnsmasq**
	- This is done using dig CLI tool and using CH class for record type
	- CH class was not intended for this purpose
	- Reference: [View DNS cache statistics](https://wiki.archlinux.org/title/Dnsmasq#View_cache_statistics)
```sh
dig -t TXT -c CH -q misses.bind
```
